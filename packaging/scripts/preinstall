#!/bin/bash
#
# PipeGuard Pre-Installation Script
# Runs before files are installed
#

set -e

echo "PipeGuard: Preparing installation..."

# Check macOS version (require 10.15+)
MACOS_VERSION=$(sw_vers -productVersion)
MAJOR_VERSION=$(echo "$MACOS_VERSION" | cut -d. -f1)

if [[ "$MAJOR_VERSION" -lt 10 ]]; then
    echo "Error: PipeGuard requires macOS 10.15 (Catalina) or later."
    echo "Detected: macOS $MACOS_VERSION"
    exit 1
fi

# Check for existing installation and back it up
if [[ -f /usr/local/bin/pipeguard ]]; then
    echo "Existing PipeGuard installation found, backing up..."
    BACKUP_DIR="/usr/local/share/pipeguard/backup-$(date +%Y%m%d%H%M%S)"
    mkdir -p "$BACKUP_DIR"
    cp /usr/local/bin/pipeguard "$BACKUP_DIR/" 2>/dev/null || true
    cp -r /usr/local/share/pipeguard/rules "$BACKUP_DIR/" 2>/dev/null || true
fi

echo "PipeGuard: Pre-installation checks passed."
exit 0
